<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin • Configurações de Análise (Diamante/Prêmio)</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #0b1220;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .admin-handshake {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999999;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.55);
            border-bottom: 1px solid rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(8px);
            font-size: 13px;
            line-height: 1.35;
        }
        .admin-handshake strong {
            color: #00FF88;
        }
        .admin-handshake code {
            color: rgba(255, 255, 255, 0.85);
        }
    </style>
</head>
<body>
    <div class="admin-handshake" id="adminHandshake">
        <strong>Admin</strong>: esta tela é usada pelo Painel Admin para configurar o módulo de análise (Diamante + Prêmio).<br>
        Aguardando autenticação via <code>postMessage</code>…
    </div>

    <script>
        // Flag usada pelo content.js para liberar a seção "Configuração do modo" somente no contexto admin
        window.__BLAZE_ADMIN_ANALYSIS_CONFIG__ = true;

        let hasAdminToken = false;
        let pendingAction = null;

        function isElementVisible(el) {
            try {
                if (!el) return false;
                if (el.hasAttribute && el.hasAttribute('hidden')) return false;
                if (el.style && el.style.display === 'none') return false;
                // offsetParent null = hidden por display none (ou dentro de hidden)
                return el.offsetParent !== null;
            } catch (_) {
                return false;
            }
        }

        function waitFor(checkFn, options) {
            const timeoutMs = (options && options.timeoutMs) ? options.timeoutMs : 8000;
            const intervalMs = (options && options.intervalMs) ? options.intervalMs : 120;
            const start = Date.now();
            return new Promise((resolve, reject) => {
                const tick = () => {
                    try {
                        const ok = checkFn();
                        if (ok) return resolve(ok);
                    } catch (_) {}
                    if ((Date.now() - start) > timeoutMs) {
                        return reject(new Error('timeout'));
                    }
                    setTimeout(tick, intervalMs);
                };
                tick();
            });
        }

        async function runAdminAction(action) {
            // 1) Abrir modal de configurações
            const cfgBtn = await waitFor(() => document.getElementById('autoBetConfigBtn'));
            try { cfgBtn.click(); } catch (_) {}

            // 2) Garantir que a seção "Configuração do modo" existe e está visível (liberada pelo token)
            const modeSection = await waitFor(() => {
                const el = document.querySelector('#autoBetAccordion .auto-bet-acc-section[data-acc-key="mode"]');
                return el && isElementVisible(el) ? el : null;
            });

            // 3) Abrir o accordion da seção "modo"
            try {
                const header = modeSection.querySelector('.auto-bet-acc-header');
                if (header) {
                    const expanded = header.getAttribute('aria-expanded') === 'true' || modeSection.classList.contains('is-open');
                    if (!expanded) header.click();
                }
            } catch (_) {}

            // 4) Ajustar modo (Premium vs Diamante) via toggle principal
            try {
                const aiToggle = await waitFor(() => document.getElementById('aiModeToggle'));
                const isAi = aiToggle.classList.contains('active');
                if (action === 'premium' && isAi) aiToggle.click();
                if (action === 'diamond' && !isAi) aiToggle.click();
            } catch (_) {}

            // 5) Para Diamante: abrir "Configurar Níveis" imediatamente
            if (action === 'diamond') {
                try {
                    const levelsBtn = await waitFor(() => {
                        const el = document.getElementById('diamondLevelsBtn');
                        return el && isElementVisible(el) ? el : null;
                    });
                    levelsBtn.click();
                } catch (_) {}
            }
        }

        function flushActionIfReady() {
            if (!hasAdminToken) return;
            if (!pendingAction) return;
            const action = pendingAction;
            pendingAction = null;
            runAdminAction(action).catch(() => {});
        }

        // Ocultar o aviso assim que o Painel Admin enviar o token
        window.addEventListener('message', (event) => {
            try {
                const data = event && event.data ? event.data : null;
                if (!data || !data.type) return;

                if (data.type === 'BLAZE_ADMIN_TOKEN') {
                    const token = data.token;
                    if (typeof token !== 'string' || token.trim().length < 20) return;
                    hasAdminToken = true;
                    const el = document.getElementById('adminHandshake');
                    if (el) el.style.display = 'none';
                    // assim que receber token, se tiver ação pendente, executar
                    setTimeout(() => flushActionIfReady(), 250);
                    return;
                }

                if (data.type === 'BLAZE_ADMIN_ACTION') {
                    const action = String(data.action || '').toLowerCase();
                    if (action !== 'premium' && action !== 'diamond') return;
                    pendingAction = action;
                    // se já tem token, executa; senão fica pendente
                    setTimeout(() => flushActionIfReady(), 250);
                    return;
                }
            } catch (_) {}
        });
    </script>

    <!-- Ordem importante: shim -> background (configs) -> content (UI) -->
    <script src="chrome-shim.js"></script>
    <script src="background.js"></script>
    <script src="content.js"></script>
</body>
</html>


